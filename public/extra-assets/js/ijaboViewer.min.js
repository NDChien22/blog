(function($){

    $.fn.ijaboViewer = function(options){
        
        let settings = $.extend({
            preview: null,
            allowedExtensions: ['jpg','jpeg','png'],
            imageShape: 'rectangular', // rectangular | square | circle
            onInvalidType: function(message){},
            onErrorShape: function(message){},
            onSuccess: function(message){

            }
        }, options);

        return this.each(function(){
            let input = $(this);

            // ðŸ”¹ Load áº£nh máº·c Ä‘á»‹nh khi khá»Ÿi táº¡o
            if(settings.preview){
                let previewElement = $(settings.preview);
                let defaultImg = previewElement.attr('data-ijabo-default-img');
                if(defaultImg){
                    previewElement.attr('src', defaultImg)
                    .css({
                        "border-radius": "0",
                        "object-fit": "cover",
                        "width": "100%",
                        "height": "100%"
                    });
                }
            }

            input.on('change', function(){
                let file = this.files[0];
                if(!file) return;

                let ext = file.name.split('.').pop().toLowerCase();

                // ðŸ”¹ Kiá»ƒm tra Ä‘á»‹nh dáº¡ng
                if(settings.allowedExtensions.indexOf(ext) == -1){
                    settings.onInvalidType("Invalid file type", input);
                    input.val('');
                    return;
                }

                let reader = new FileReader();
                reader.onload = function(e){

                    let img = new Image();
                    img.src = e.target.result;

                    img.onload = function(){

                        // ðŸ”¹ Kiá»ƒm tra shape
                        if(settings.imageShape === 'square'){
                            if(img.width !== img.height){
                                settings.onErrorShape("Image must be square", input);
                                input.val('');
                                return;
                            }
                        } else if(settings.imageShape === 'rectangular'){
                            if(img.width === img.height){
                                settings.onErrorShape("Image must be rectangular", input);
                                input.val('');
                                return;
                            }
                        }

                        // ðŸ”¹ GÃ¡n hÃ¬nh preview
                        if(settings.preview){
                            $(settings.preview).attr('src', e.target.result)
                            .css({
                                    "border-radius": "0",
                                    "object-fit": "cover"
                                });
                            
                        }

                        settings.onSuccess("Preview loaded successfully", input);
                    };
                };

                reader.readAsDataURL(file);
            });

        });

    };

}(jQuery));
